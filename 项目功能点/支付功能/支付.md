# 一、支付平台

系统中的支付功能需要我们跟支付平台做对接来完成，现在市场上的支付平台分为下面两种

* 聚合支付平台：是第三方的支付平台，常见的又ping++等，他们已经与其他常见的支付厂商做过对接并开放接口给我们使用，我们使用他的支付接口可以减少维护成本，但是需要提供额外的费用并且系统中的支付功能都需要经过这种第三方的支付平台来完成，不可控因素太多，一般只有对支付需求不是很高的小公司才会使用
* 直接与厂家对接：常见的支付厂家如，支付宝、微信、中国银联，他们都有自己的开放平台，其中都提供有接口文档和demo我们可以直接写代码进行支付对接

# 二、支付功能实现思路

1. 首先在微服务项目中，支付功能肯定是要单独创建一个项目来进行维护的
2. 为支付功能设计表结构，主要需要如下表
   * 支付渠道表：存储支付渠道信息的，例如支付宝、微信等都是支付渠道，我们需要使用这张表存储每个支付渠道的具体信息，为每个渠道生成一条记录，记录如下信息AppID或者交商户ID、同步回调地址异步回掉地址、加密用的私钥公钥等信息。
   * 支付记录表：用来进行对账时使用，主要记录如下信息，用户ID、订单ID、支付金额、支付状态等信息
   * 支付交易日志表：用来记录支付时产生的日志信息用来排查支付时出现的问题，记录如下信息，支付渠道ID、支付ID、同步回调日志、异步回调日志信息。

3. 去对接支付的开放平台中申请账号

   不同的平台申请完账号后会提供给我们不同的信息，但大致都会提供一个类如AppID、密钥等信息，这些信息需要我们在访问支付平台的接口时提供。

4. 对接支付接口

   接下来我们可以到不同厂商的开发平台找到响应的支付对接文档进行支付对接，一般都是分为以下两个步骤

   4.1 获取厂商提供的支付页面：

   ​	根据不同终端获取支付页面的形式也不同，大致分为以下三大类，1.可以直接通过支付接口获取到HTML页面以自动表单跳转的方式访问到厂商的支付页面，2.通过接口获取到支付二维码，3.通过接口获取到对应厂商的支付ID等核心参数让前端通过这些参数调用SDK来拉取移动端的支付窗口，不管通过什么形式最终都会引导用户到厂商的支付窗口中进行支付

   ​	支付接口的调用需要传递很多参数，不同厂商要传递的参数列表、验签、加密方式等都不一样，我们可以直接到对应开放平台中下载demo进行复用，一般只需要把参数修改成我们自己的内容例如：支付金额、AppID等即可，大部分参数都是demo中固定的不需要我们调整

   ​	在编写代码时由于需要对接各种不同的支付平台，同一种功能需要很多种不同的实现，这时我们可以使用策略模式来设计代码结构，创建一个支付接口并为不同支付平台创建实现类，当前端引导用户调用我们某个渠道的支付时，我们可通过支付渠道表中存储的策略实现类名称，通过反射的方式来获取到实例为不同支付渠道提供不同的服务避免每次都使用if else来优化代码。

   ​	使用反射获取支付实例时也可以采用工厂模式来优化代码，写一个工厂类根据提供的className来创建一个单例的实例防止没必要的重复实例化类。

   

   4.2 编写回调接口获取支付结果

   ​	当我们向例如微信发起支付接口请求时会携带回调地址，当微信那边支付完成时会回掉我们的地址进行通知支付结果。

   ​	（1）编写支付回调接口

   ​	（2）获取对应参数

   ​	（3）获取支付结果

   ​	（4）如果支付结果是失败，则返回失败消息提示，如非官方指定的成功message给微信或支付宝让其重		  试

   ​        （5）如果支付成功则进行后续的业务逻辑操作，修改订单状态为成功

​               （6）然后为支付后的用户添加积分等

​	       （7）最后使用官方指定的成功msg响应。

​		由于不同支付渠道的回调处理逻辑是一样的，只有在一些细节的实现上有所不同，这里我们可以使用模   板方法设计模式对代码进行优化，首先定义模板类，实现回调接口，完成主要逻辑，其中逻辑中的具体实现可以定义为抽象方法让子类去实现，例如:获取回调参数可以定义到抽象方法中让子类去实现，而对支付结果的判断在模板方法中完成。这样的好处时，不同支付渠道的回调实现中我们只需要关注不同点，相同点只需要写一次代码就可以了。

5. 退款接口的对接，与支付接口类似使用
6. 对账，采用定时任务每日自动对账，通过提供的对账文件下载接口获取对账文件与系统账单进行对账，如果发现由金额不对等的情况则进行人工处理。

# 三、支付中存在的分布式事务问题

1. 问题分析

   当我们获取到支付成功的结果时需要修改订单状态，并为用户添加积分，在微服务中积分是单独的一个系统，这里就存在的分布式事务问题，很有可能会发生订单状态修改成功但积分为添加成功能情况。

2. 解决思路

   解决思路是使用最终一致性原则，采用MQ来实现重试+补偿的方式来保证数据的最终一致性，具体实现如下

   在生产者端，在支付回调中使用MQ来传递添加用户积分的消息，并编写消息确认回调函数，当回调函数被执行但消息为被确认掉的话则进行重试接着把消息发送到MQ中。

   在消费者端，提供俩个消费者队列与消费者，其中一个是积分服务消费者、一个是补偿消费者，当补偿消费者接收到添加积分的消息后会查询当前订单的支付状态，如果状态时未支付成功的话则进行补偿，把支付状态变为成功。